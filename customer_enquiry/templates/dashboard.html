{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>GRE Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        /* Standard header styles from other pages */
        .header {
            position: relative;
            padding: 24px 36px;
            background: #333333;
            color: #374151;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .brand-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 12px;
            position: relative;
            z-index: 2;
        }

        .brand-row img {
            height: 80px;
            width: auto;
        }

        .header-text {
            flex: 1;
            text-align: center;
        }

        .title {
            font-weight: 400;
            font-size: 32px;
            line-height: 1.1;
            margin: 0 0 6px 0;
            color: #fff;
            letter-spacing: -0.5px;
        }

        .subtitle {
            font-size: 15px;
            color: #fff;
            font-weight: 400;
            line-height: 1.4;
            margin: 0;
        }

        /* Updated decorative elements */
        .dec {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            z-index: 1;
        }

        .dec img {
            height: 80px;
            width: auto;
        }

        /* Subtle pattern overlay */
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.03"><circle cx="30" cy="30" r="1"/></g></svg>');
            pointer-events: none;
        }
        
        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .action-buttons-top {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background-color: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .assessment-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 4px;
        }
        
        .assessment-complete {
            background: #d4edda;
            color: #155724;
        }
        
        .assessment-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .property-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .phone-number {
            font-weight: 500;
            color: #495057;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .filter-info {
            background: #e9f7ef;
            border: 1px solid #27ae60;
            border-radius: 4px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #1e8449;
            display: none;
        }
        
        .filter-info.active {
            display: block;
        }
        
        .no-results-container {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-results-container h3 {
            color: #888;
            margin-bottom: 10px;
        }
        
        .no-results-container p {
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .no-results-container .btn {
            margin: 0 5px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .filters-container {
                grid-template-columns: 1fr;
            }
            
            .action-buttons-top {
                flex-direction: column;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Standard header from other pages -->
    <header class="header">
        <div class="brand-row">
            <div class="header-text">
                <div class="title">Customer Enquiry</div>
                <div class="subtitle">Dashboard and Lead Management</div>
            </div>
        </div>
        <div class="dec">
            <img src="{% static 'media/spenta_white.png' %}" alt="Spenta Logo" onerror="this.style.display='none';">
        </div>
    </header>
    
    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 20px 0;">All Leads Dashboard</h2>
        
        <!-- Filters -->
        <div class="filters-container">
            <div class="filter-group">
                <label for="searchInput">Search</label>
                <input type="text" id="searchInput" placeholder="Search by name, email, phone, form number...">
            </div>
            
            <div class="filter-group">
                <label for="propertyFilter">Property Filter</label>
                <select id="propertyFilter">
                    <option value="">All Properties</option>
                    <option value="ALT">Altavista</option>
                    <option value="ORN">Ornata</option>
                    <option value="MED">Medius</option>
                    <option value="STAR">Spenta Stardeous</option>
                    <option value="ANT">Spenta Anthea</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="dateFrom">Date From</label>
                <input type="date" id="dateFrom">
            </div>
            
            <div class="filter-group">
                <label for="dateTo">Date To</label>
                <input type="date" id="dateTo">
            </div>
            
            <div class="filter-group">
                <label for="assessmentFilter">Assessment Status</label>
                <select id="assessmentFilter">
                    <option value="">All</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="bookingFilter">Booking Status</label>
                <select id="bookingFilter">
                    <option value="">All</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons-top">
            <button class="btn btn-primary" onclick="applyFilters()">🔍 Apply Filters</button>
            <button class="btn btn-success" onclick="exportToExcel()">📊 Export to Excel</button>
            <button class="btn btn-secondary" onclick="clearFilters()">🔄 Clear Filters</button>
            <button class="btn btn-info" onclick="refreshData()">♻️ Refresh</button>
        </div>
    </div>
    
    <!-- Filter Information -->
    <div class="filter-info" id="filterInfo"></div>
    
    <!-- Statistics -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-number" id="totalLeads">{{ customers|length }}</div>
            <div class="stat-label">Total Leads</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="filteredLeads">{{ customers|length }}</div>
            <div class="stat-label">Filtered Results</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completedAssessments">
                {% for customer in customers %}
                    {% if customer.sales_assessment %}1{% endif %}
                {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Assessments Done</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="completedBookings">
                {% for customer in customers %}
                    {% if customer.booking_applications.exists %}1{% endif %}
                {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Bookings Done</div>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div class="loading" id="loadingIndicator">
        <p>Loading...</p>
    </div>
    
    <!-- Table -->
    <div class="table-container">
        <table id="leadsTable">
            <thead>
                <tr>
                    <th>Form Number</th>
                    <th>Full Name</th>
                    <th>Property</th>
                    <th>Phone Number</th>
                    <th>City</th>
                    <th>Lead Source(s)</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="leadsTableBody">
                {% for customer in customers %}
                <tr data-property="" 
                    data-date="{{ customer.created_at|date:'Y-m-d' }}"
                    data-assessment="{% if customer.sales_assessment %}completed{% else %}pending{% endif %}"
                    data-booking="{% if customer.booking_applications.exists %}completed{% else %}pending{% endif %}"
                    data-search="{{ customer.form_number|lower }} {{ customer.get_full_name|lower }} {{ customer.email|lower }} {{ customer.city|lower }} {{ customer.phone_number|default:'' }}"
                    data-form-number="{{ customer.form_number }}"
                    style="display: table-row;">
                    
                    <td>
                        <span class="property-tag property-tag-js">{{ customer.form_number|slice:':3' }}</span> <span class="form-number-display">{{ customer.form_number }}</span>
                    </td>
                    <td>
                        <strong>{{ customer.get_full_name }}</strong>
                        <br><small style="color: #666;">{{ customer.email }}</small>
                    </td>
                    <td class="property-name-js">
                        Loading...
                    </td>
                    <td>
                        <span class="phone-number">{{ customer.phone_number|default:'Not Provided' }}</span>
                    </td>
                    <td>{{ customer.city }}</td>
                    
                    <td>
                        {% for source in customer.sources.all %}
                            {% with display_text=source.get_source_type_display %}
                                {% if 'Social Media' in display_text %}
                                    Social Media
                                {% else %}
                                    {{ display_text }}
                                {% endif %}{% if not forloop.last %}, {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </td>


                    <td>{{ customer.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="action-buttons">
                        <!-- Edit Customer Button -->
                        <a href="{% url 'customer_enquiry:edit_customer' customer.pk %}" class="btn btn-primary">
                            View
                        </a>
                        
                        <!-- Internal Assessment Button -->
                        <a href="{% url 'customer_enquiry:internal_sales_assessment' customer.pk %}" class="btn btn-success">
                            Assessment
                            {% if customer.sales_assessment %}
                                <span class="assessment-status assessment-complete">✓</span>
                            {% else %}
                                <span class="assessment-status assessment-pending">⚠</span>
                            {% endif %}
                        </a>
            
                        <!-- Booking Form Button -->
                        <a href="{% url 'customer_enquiry:booking_form' customer.pk %}" class="btn btn-warning">
                            Booking
                            {% if customer.booking_applications.exists %}
                                <span class="assessment-status assessment-complete">✓</span>
                            {% else %}
                                <span class="assessment-status assessment-pending">⚠</span>
                            {% endif %}
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="no-results">No leads found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // Global variables
        let allRows = [];
        let filteredRows = [];
        let searchTimeout;
        
        // Property mapping function
        function getPropertyFromFormNumber(formNumber) {
            if (!formNumber) return { code: '', name: 'Unknown' };
            
            // Convert to uppercase for consistent checking
            const upperFormNumber = formNumber.toUpperCase();
            
            if (upperFormNumber.startsWith('STAR')) {
                return { code: 'STAR', name: 'Spenta Stardeous' };
            } else if (upperFormNumber.startsWith('ANT')) {
                return { code: 'ANT', name: 'Spenta Anthea' };
            } else if (upperFormNumber.startsWith('ORN')) {
                return { code: 'ORN', name: 'Ornata' };
            } else if (upperFormNumber.startsWith('MED')) {
                return { code: 'MED', name: 'Medius' };
            } else if (upperFormNumber.startsWith('ALT')) {
                return { code: 'ALT', name: 'Altavista' };
            } else {
                return { code: formNumber.substring(0, 3).toUpperCase(), name: 'Unknown Property' };
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Store all table rows for filtering and populate property data
            const allTableRows = Array.from(document.querySelectorAll('#leadsTableBody tr'));
            
            // Filter out any existing no-results rows and store only data rows
            allRows = allTableRows.filter(row => {
                return row.dataset.formNumber && !row.querySelector('.no-results');
            });
            
            console.log(`Found ${allRows.length} data rows for filtering`);
            
            // Debug: Check search data for first few rows
            allRows.slice(0, 3).forEach((row, index) => {
                console.log(`Row ${index} search data:`, row.dataset.search);
            });
            
            // Populate property information using JavaScript
            allRows.forEach((row, index) => {
                const formNumber = row.dataset.formNumber;
                
                if (formNumber) {
                    const property = getPropertyFromFormNumber(formNumber);
                    
                    // Set data attribute for filtering
                    row.dataset.property = property.code;
                    
                    // Update property tag
                    const propertyTag = row.querySelector('.property-tag-js');
                    if (propertyTag) {
                        propertyTag.textContent = property.code;
                    }
                    
                    // Update property name
                    const propertyName = row.querySelector('.property-name-js');
                    if (propertyName) {
                        propertyName.textContent = property.name;
                    }

                    // Format form number display to uppercase
                    const formNumberDisplay = row.querySelector('.form-number-display');
                    if (formNumberDisplay) {
                        let formNumber = formNumberDisplay.textContent.trim();
                        if (formNumber.includes('-')) {
                            const parts = formNumber.split('-');
                            parts[0] = parts[0].toUpperCase();
                            formNumberDisplay.textContent = parts.join('-');
                        }
                    }
                }
            });
            
            // Initialize filtered rows
            filteredRows = [...allRows];
            
            // Add event listeners for real-time search
            const searchInput = document.getElementById('searchInput');
            
            // Single event listener that handles both typing and clearing
            searchInput.addEventListener('input', function(e) {
                const currentValue = e.target.value.trim();
                console.log('Search input changed:', `"${currentValue}"`);
                
                // Clear any existing timeout
                clearTimeout(searchTimeout);
                
                if (currentValue === '') {
                    // If search is empty, apply other filters immediately (but skip search filter)
                    console.log('Search is empty - applying non-search filters');
                    applyFiltersExceptSearch();
                    
                    // Force an immediate table display update as failsafe
                    setTimeout(() => {
                        console.log('Failsafe: Force updating table display');
                        updateTableDisplay();
                    }, 10);
                } else {
                    // If search has content, debounce the filtering
                    searchTimeout = setTimeout(() => {
                        console.log('Applying debounced search filter');
                        applyFilters();
                    }, 300);
                }
            });
            document.getElementById('propertyFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFrom').addEventListener('change', applyFilters);
            document.getElementById('dateTo').addEventListener('change', applyFilters);
            document.getElementById('assessmentFilter').addEventListener('change', applyFilters);
            document.getElementById('bookingFilter').addEventListener('change', applyFilters);
            
            // Show all rows initially
            updateTableDisplay();
            updateStatistics();
            updateFilterInfo();
        });
        
        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function applyFiltersExceptSearch() {
            // Apply all filters except search (for when search is cleared)
            const propertyFilter = document.getElementById('propertyFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const assessmentFilter = document.getElementById('assessmentFilter').value;
            const bookingFilter = document.getElementById('bookingFilter').value;
            
            console.log('Applying filters except search:', {
                propertyFilter,
                dateFrom,
                dateTo,
                assessmentFilter,
                bookingFilter
            });
            
            // Always start filtering from all rows
            filteredRows = allRows.filter(row => {
                // Skip if row doesn't have required data
                if (!row.dataset || !row.cells || row.cells.length < 8) {
                    return false;
                }
                
                const property = row.dataset.property || '';
                const date = row.dataset.date || '';
                const assessment = row.dataset.assessment || '';
                const booking = row.dataset.booking || '';
                
                // Skip search filter - only apply other filters
                
                // Property filter
                if (propertyFilter && property !== propertyFilter) {
                    return false;
                }
                
                // Date filter
                if (dateFrom && date < dateFrom) {
                    return false;
                }
                if (dateTo && date > dateTo) {
                    return false;
                }
                
                // Assessment filter
                if (assessmentFilter && assessment !== assessmentFilter) {
                    return false;
                }
                
                // Booking filter
                if (bookingFilter && booking !== bookingFilter) {
                    return false;
                }
                
                return true;
            });
            
            console.log(`Filtered (without search) from ${allRows.length} to ${filteredRows.length} rows`);
            
            // Update display
            updateTableDisplay();
            updateStatistics();
            updateFilterInfo();
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const propertyFilter = document.getElementById('propertyFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const assessmentFilter = document.getElementById('assessmentFilter').value;
            const bookingFilter = document.getElementById('bookingFilter').value;
            
            console.log('Applying filters:', {
                searchTerm: `"${searchTerm}"`,
                searchTermLength: searchTerm.length,
                propertyFilter,
                dateFrom,
                dateTo,
                assessmentFilter,
                bookingFilter
            });
            
            // Always start filtering from all rows to ensure consistency
            filteredRows = allRows.filter(row => {
                // Skip if row doesn't have required data
                if (!row.dataset || !row.cells || row.cells.length < 8) {
                    return false;
                }
                
                const searchData = row.dataset.search || '';
                const property = row.dataset.property || '';
                const date = row.dataset.date || '';
                const assessment = row.dataset.assessment || '';
                const booking = row.dataset.booking || '';
                
                // Search filter
                if (searchTerm && searchTerm.length > 0) {
                    if (!searchData.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Property filter
                if (propertyFilter && property !== propertyFilter) {
                    return false;
                }
                
                // Date filter
                if (dateFrom && date < dateFrom) {
                    return false;
                }
                if (dateTo && date > dateTo) {
                    return false;
                }
                
                // Assessment filter
                if (assessmentFilter && assessment !== assessmentFilter) {
                    return false;
                }
                
                // Booking filter
                if (bookingFilter && booking !== bookingFilter) {
                    return false;
                }
                
                return true;
            });
            
            console.log(`Filtered from ${allRows.length} to ${filteredRows.length} rows`);
            
            if (filteredRows.length === 0) {
                console.log('No rows passed filter - checking why...');
                // Debug: show why first few rows were filtered out
                allRows.slice(0, 3).forEach((row, index) => {
                    const searchData = row.dataset.search || '';
                    const property = row.dataset.property || '';
                    console.log(`Row ${index} - searchData: "${searchData}", property: "${property}"`);
                });
            }
            
            // Update display and show active filters
            updateTableDisplay();
            updateStatistics();
            updateFilterInfo();
        }
        
        function updateTableDisplay() {
            const tbody = document.getElementById('leadsTableBody');
            console.log(`Updating table display with ${filteredRows.length} filtered rows`);
            
            // First, remove any existing no-results rows
            const noResultsRows = tbody.querySelectorAll('.no-results-container, .no-results');
            noResultsRows.forEach(noResultElement => {
                const noResultRow = noResultElement.closest('tr');
                if (noResultRow) {
                    noResultRow.remove();
                }
            });
            
            // Hide ALL rows initially (more reliable approach)
            const allTableRows = tbody.querySelectorAll('tr');
            allTableRows.forEach(row => {
                row.style.display = 'none';
            });
            
            // Show filtered rows or display no-results message
            if (filteredRows.length === 0) {
                console.log('No filtered rows - showing no results message');
                // Create and insert enhanced no-results row
                const noResultsRow = document.createElement('tr');
                noResultsRow.innerHTML = `
                    <td colspan="8" class="no-results-container">
                        <h3>🔍 No Results Found</h3>
                        <p>We couldn't find any leads matching your current filter criteria.</p>
                        <p>Try adjusting your filters or clearing them to see more results.</p>
                        <button class="btn btn-primary" onclick="clearFilters()">🔄 Clear All Filters</button>
                        <button class="btn btn-secondary" onclick="refreshData()">♻️ Refresh Data</button>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            } else {
                console.log(`Showing ${filteredRows.length} filtered rows`);
                // Show filtered rows - more robust approach
                filteredRows.forEach((row, index) => {
                    console.log(`Showing row ${index}:`, row.dataset.formNumber);
                    row.style.display = 'table-row';
                    
                    // Ensure the row is properly attached to tbody if it got detached
                    if (row.parentNode !== tbody) {
                        tbody.appendChild(row);
                    }
                });
                console.log('All filtered rows should now be visible');
            }
        }
        
        function updateStatistics() {
            document.getElementById('filteredLeads').textContent = filteredRows.length;
            
            let completedAssessments = 0;
            let completedBookings = 0;
            
            filteredRows.forEach(row => {
                if (row.dataset.assessment === 'completed') completedAssessments++;
                if (row.dataset.booking === 'completed') completedBookings++;
            });
            
            document.getElementById('completedAssessments').textContent = completedAssessments;
            document.getElementById('completedBookings').textContent = completedBookings;
        }
        
        function updateFilterInfo() {
            const filterInfo = document.getElementById('filterInfo');
            const activeFilters = [];
            
            const searchTerm = document.getElementById('searchInput').value;
            const propertyFilter = document.getElementById('propertyFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const assessmentFilter = document.getElementById('assessmentFilter').value;
            const bookingFilter = document.getElementById('bookingFilter').value;
            
            if (searchTerm) activeFilters.push(`Search: "${searchTerm}"`);
            if (propertyFilter) {
                const propertyName = document.getElementById('propertyFilter').options[document.getElementById('propertyFilter').selectedIndex].text;
                activeFilters.push(`Property: ${propertyName}`);
            }
            if (dateFrom) activeFilters.push(`From: ${dateFrom}`);
            if (dateTo) activeFilters.push(`To: ${dateTo}`);
            if (assessmentFilter) activeFilters.push(`Assessment: ${assessmentFilter}`);
            if (bookingFilter) activeFilters.push(`Booking: ${bookingFilter}`);
            
            if (activeFilters.length > 0) {
                filterInfo.innerHTML = `🔍 Active Filters: ${activeFilters.join(' • ')} <button class="btn btn-secondary btn-sm" onclick="clearFilters()" style="margin-left: 10px; padding: 2px 8px; font-size: 11px;">Clear All</button>`;
                filterInfo.classList.add('active');
            } else {
                filterInfo.classList.remove('active');
            }
        }
        
        function clearFilters() {
            console.log('Clearing all filters');
            
            // Clear all filter inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('propertyFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('assessmentFilter').value = '';
            document.getElementById('bookingFilter').value = '';
            
            // Force clear any search timeouts
            clearTimeout(searchTimeout);
            
            // Reset filtered rows to all rows
            filteredRows = [...allRows];
            
            console.log(`Reset to ${filteredRows.length} rows from total ${allRows.length}`);
            
            // Update display immediately
            updateTableDisplay();
            updateStatistics();
            updateFilterInfo();
        }
        
        function refreshData() {
            document.getElementById('loadingIndicator').style.display = 'block';
            window.location.reload();
        }
        
        function exportToExcel() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            
            // Get current filters
            const searchTerm = document.getElementById('searchInput').value;
            const propertyFilter = document.getElementById('propertyFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const assessmentFilter = document.getElementById('assessmentFilter').value;
            const bookingFilter = document.getElementById('bookingFilter').value;
            
            // Create form data
            const formData = new FormData();
            formData.append('search', searchTerm);
            formData.append('property', propertyFilter);
            formData.append('date_from', dateFrom);
            formData.append('date_to', dateTo);
            formData.append('assessment', assessmentFilter);
            formData.append('booking', bookingFilter);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            // Send request to export endpoint
            fetch('/export-leads/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Export failed');
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Generate filename with timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const propertyName = propertyFilter ? `_${propertyFilter}` : '_All';
                a.download = `leads_export${propertyName}_${timestamp}.xlsx`;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                loadingIndicator.style.display = 'none';
                alert('Export completed successfully!');
            })
            .catch(error => {
                console.error('Export error:', error);
                loadingIndicator.style.display = 'none';
                alert('Export failed. Please try again.');
            });
        }
        
        // Debug function - you can call this from browser console
        function debugFilterState() {
            console.log('=== FILTER DEBUG INFO ===');
            console.log('Total rows:', allRows.length);
            console.log('Filtered rows:', filteredRows.length);
            console.log('Search input value:', `"${document.getElementById('searchInput').value}"`);
            console.log('Search input trimmed:', `"${document.getElementById('searchInput').value.trim()}"`);
            console.log('Property filter:', document.getElementById('propertyFilter').value);
            
            // Check table display state
            const tbody = document.getElementById('leadsTableBody');
            const visibleRows = tbody.querySelectorAll('tr[style*="table-row"]');
            const hiddenRows = tbody.querySelectorAll('tr[style*="none"]');
            console.log('Visible rows in DOM:', visibleRows.length);
            console.log('Hidden rows in DOM:', hiddenRows.length);
            
            console.log('First 3 filtered rows display status:');
            filteredRows.slice(0, 3).forEach((row, index) => {
                console.log(`Filtered Row ${index}:`, {
                    formNumber: row.dataset.formNumber,
                    display: row.style.display,
                    parentNode: row.parentNode === tbody ? 'correct parent' : 'wrong parent',
                    inDOM: document.body.contains(row)
                });
            });
            
            console.log('First 3 all rows display status:');
            allRows.slice(0, 3).forEach((row, index) => {
                console.log(`All Row ${index}:`, {
                    formNumber: row.dataset.formNumber,
                    display: row.style.display,
                    parentNode: row.parentNode === tbody ? 'correct parent' : 'wrong parent'
                });
            });
            
            console.log('========================');
        }
        
        // Emergency function to force show all rows - call this from browser console if needed
        function forceShowAllRows() {
            console.log('Emergency: Force showing all rows');
            const tbody = document.getElementById('leadsTableBody');
            
            // Remove any no-results rows
            const noResultsRows = tbody.querySelectorAll('.no-results-container, .no-results');
            noResultsRows.forEach(noResultElement => {
                const noResultRow = noResultElement.closest('tr');
                if (noResultRow) {
                    noResultRow.remove();
                }
            });
            
            // Reset filtered rows to all rows
            filteredRows = [...allRows];
            
            // Force display all rows
            allRows.forEach((row, index) => {
                console.log(`Emergency showing row ${index}:`, row.dataset.formNumber);
                row.style.display = 'table-row';
                if (row.parentNode !== tbody) {
                    tbody.appendChild(row);
                }
            });
            
            // Update statistics
            updateStatistics();
            updateFilterInfo();
            
            console.log(`Emergency: Showed ${allRows.length} rows`);
        }
    </script>
    
    <!-- CSRF Token for AJAX requests -->
    {% csrf_token %}
</body>
</html>